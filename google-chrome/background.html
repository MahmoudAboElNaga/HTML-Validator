<html>
	<script>
		var htmlvalidatorbackground = function () {
			var init = function () {
				chrome.browserAction.onClicked.addListener(function (tab) {
					validate();
				});

				chrome.extension.onRequest.addListener(
					function (request, sender, sendResponse) {
						if (request.validate) {
							validate();
						}
						else if (request.autoruncheck) {
							var autorun = getPref("autorun") || "false";
							if (typeof autorun !== "undefined" && autorun === "true") {
								validate();
							}
						}
					}
				);
			},
			
			validate = function (validation) {
				chrome.tabs.getSelected(null, function (tab) {
					var validatorType = validation || getPref("validator") || "inline",
						autorun = getPref("autorun") || "false",
						tabUrl = tab.url;

					if (validatorType === "inline" && (!/validator\.nu/.test(tabUrl) && autorun)) { // To avoid inline validation of the Validator.nu validator
						
						// To clear possible previous ongoing validation attempts
						clearTimeout(timer);
						clearTimeout(loadingTimer);

						/*
							Commented out URL for possible future use of the W3C API.
							As of now, though, it doesn't return valid JSON
						*/
						//var url = "http://validator.w3.org/check?uri=" + tab.url + ";output=json",
						var url = "http://validator.nu/?doc=" + tabUrl + "&out=json",
							xhr = new XMLHttpRequest(),
							timer,
							loadingTimer,
							sendResults = function (result) {
								clearTimeout(loadingTimer);
								chrome.tabs.sendRequest(
									tab.id, 
									{
										results: result
									}
								);
							};
						
						// Hides any possible validating loading indicator	
						sendResults({
							"message" : "hide-loading"
						});

						timer = window.setTimeout(function () {
							xhr.abort();
							sendResults({
								"message" : "Validation timed out. Please try again."
							});
						}, 2000);

						// If the result is finished, send validation results to the page
						xhr.onreadystatechange = function () {
							if (xhr.readyState === 4) {
								clearTimeout(timer);
								sendResults(xhr.responseText);
							}
						};

						xhr.onerror = function () {
							clearTimeout(timer);
							sendResults({
								"message" : "Validation failed. Please try again."
							});
						};

						// Show validating loading
						loadingTimer = window.setTimeout(function () {
							sendResults({
								"message" : "show-loading"
							});
						}, 200);

						// Send validation request to validator.nu
						xhr.open("GET", url, true);
						xhr.send(null);
					}
					else if (validatorType === "new-tab" && !/validator\.w3\.org/.test(tabUrl)) { // URL check to avoid validating the W3C or Validator.nu validator... :-)
						chrome.tabs.create({
							url : "http://validator.w3.org/check?uri=" + tabUrl
						});
					}
				});
			},

			getPref = function (pref) {
				return localStorage[pref];
			},

			getPrefs = function () {
				return {
					autorun : localStorage["autorun"],
					validator : localStorage["validator"],
					popup : localStorage["popup"]
				};
			},
			
			setPref = function (pref, value) {
				return localStorage[pref] = value;
			},

			setPrefs = function (prefs) {
				for (var i in prefs) {
					localStorage[i] = prefs[i];
				}	
			},
			
			checkPopupPref = function (popupMethod) {
				usePopUpMenu = getPref("popup") || "true";
				if (usePopUpMenu === "no-popup") {
					validate();
					popupMethod();
				}
			};
			
			return {
				init : init,
				validate : validate,
				getPrefs : getPrefs,
				setPref : setPref,
				setPrefs : setPrefs,
				checkPopupPref : checkPopupPref
			};
		}();
		htmlvalidatorbackground.init();
	</script>	
</html>